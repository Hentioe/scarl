clone:
  git:
    image: plugins/git
    tags: true

pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - /root/.mix
      - deps
    volumes:
      - /data/cache/scarl:/cache

  test:
    image: bluerain/elixir-1.7-slim:mix-locals
    when:
      event: [push, tag, deployment]
    commands:
      - cp /home/app/*.secret.exs apps/bot/config/
      - mix deps.get
      - MIX_ENV=test mix cmd --app storage mix ecto.migrate
      - MIX_ENV=test mix cmd --app storage mix test
    volumes:
      - /data/apps/scarl/:/home/app

  build:
    image: bluerain/elixir-1.7-slim:mix-locals
    when:
      event: [push, tag, deployment]
    commands:
      - MIX_ENV=prod mix cmd --app bot mix release
      - MIX_ENV=prod mix ecto.migrate
    volumes:
      - /data/apps/scarl/db:/home/app/scarl-prod.sqlite3

  publish:
      image: plugins/docker
      when:
        event: [push, tag, deployment]
      repo: bluerain/scarl
      auto_tag: true
      dockerfile: Dockerfile
      secrets: [ docker_username, docker_password ]
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - /data/apps/scarl/db:/home/app/scarl-prod.sqlite3

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - /root/.mix
      - deps
    volumes:
      - /data/cache/scarl:/cache
